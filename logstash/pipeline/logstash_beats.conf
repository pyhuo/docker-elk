## n
input {
    beats {
        port => '5044'
    }
}

filter {
    if [fileset][name] == 'access' {
        grok {
            match => { "message" => ["%{IPORHOST:[nginx][access][remote_ip]} - %{DATA:[nginx][access][user_name]} \[%{HTTPDATE:[nginx][access][time]}\] \"%{WORD:[nginx][access][method]} %{DATA:[nginx][access][url]} HTTP/%{NUMBER:[nginx][access][http_version]}\" %{NUMBER:[nginx][access][response_code]} %{NUMBER:[nginx][access][body_sent][bytes]} \"%{DATA:[nginx][access][referrer]}\" \"%{DATA:[nginx][access][agent]}\""] }
            remove_field => "message"
        }
        mutate {
            convert => { "body_sent_bytes" => "integer" }
            convert => { "upstream_response_time" => "float" }
        }
        geoip {
            source => "[nginx][access][remote_ip]"
            target => "[nginx][access][geoip]"
        }
    }
    if [fileset][name] == "error" {
        grok {
            match => { "message" => ["%{DATA:[nginx][error][time]} \[%{DATA:[nginx][error][level]}\] %{NUMBER:[nginx][error][pid]}#%{NUMBER:[nginx][error][tid]}: (\*%{NUMBER:[nginx][error][connection_id]} )?%{GREEDYDATA:[nginx][error][message]}(?:, client: (?<clientip>%{IP}|%{HOSTNAME}))(?:, server: %{IPORHOST:[nginx][error][server]})(?:, request: \"%{WORD:[nginx][error][method]} %{URIPATHPARAM:[nginx][error][uri]} HTTP/%{NUMBER:[nginx][error][httpversion]}\")(?:, host: \"%{IPORHOST:[nignx][error][host]}\")"] }
            remove_field => "message"
        }
        mutate {
            rename => { "clientip" => "[nginx][error][client_ip]" }
        }
        geoip {
            source => "[nginx][error][client_ip]"
            target => "[nginx][error][geoip]"
        }
    }

    if "YamiAPI" in [source] {
        # /home/ubuntu/Documents/510YamiAPI/logs/debug_json.log
        mutate {
            remove_field => ["tags", "beat", "host", "log"]
            add_field => { "[server_name]" => "YamiAPI" }
        }
        date {
            timezone => "UTC"
            match => ["[json][timestamp]", "UNIX_MS"]
            target => "create_at"
        }
    } else if "MapServer" in [source] {
        mutate {
            remove_field => ["tags", "beat", "host", "log"]
            add_field => { "[server_name]" => "MapServer" }
        }
        date {
            timezone => "UTC"
            match => ["[json][timestamp]", "UNIX_MS"]
            target => "create_at"
        }
    } else if "NavServerPro" in [source] {
        mutate {
            remove_field => ["tags", "beat", "host", "log"]
            add_field => { "[server_name]" => "NavServerPro" }
        }
        date {
            timezone => "UTC"
            match => ["[json][timestamp]", "UNIX_MS"]
            target => "create_at"
        }
    } else if "yami_admin" in [source] {
        mutate {
            remove_field => ["tags", "beat", "host", "log"]
            add_field => { "[server_name]" => "yamiAdmin" }
        }
        date {
            timezone => "UTC"
            match => ["[json][timestamp]", "UNIX_MS"]
            target => "create_at"
        }
    }
}

output {
    if [fileset][name] == "access" {
        elasticsearch {
			hosts => "elasticsearch:9200"
            index => "filebeat-6.6.1-nginx-access-%{+YYYY.MM.dd}"
            #template_overwrite => true
            user => logstash
            password => logstash
        }
    }

    if [fileset][name] == "error" {
        elasticsearch {
			hosts => "elasticsearch:9200"
            index => "filebeat-6.6.1-nginx-error-%{+YYYY.MM.dd}"
            #template_overwrite => true
            user => logstash
            password => logstash
        }
    }

    if [server_name] == 'YamiAPI'  {
        stdout {
            codec => rubydebug
        }
        elasticsearch {
			hosts => "elasticsearch:9200"
            index => "logstash-yami-api-%{+YYYY.MM.dd}"
            #template_overwrite => true
            user => logstash
            password => logstash
        }
    } else if [server_name] == 'yamiAdmin'  {
        stdout {
            codec => rubydebug
        }
        elasticsearch {
			hosts => "elasticsearch:9200"
            index => "logstash-yami-admin-%{+YYYY.MM.dd}"
            #template_overwrite => true
            user => logstash
            password => logstash
        }
    }

    # if [server_name] == 'MapServer'  {
    #     stdout {
    #         codec => rubydebug
    #     }
    #     elasticsearch {
	# 		hosts => "elasticsearch:9200"
    #         index => "logstash-map-server-%{+YYYY.MM.dd}"
    #         #template_overwrite => true
    #         user => logstash
    #         password => logstash
    #     }
    # }

    # if [server_name] == 'NavServerPro'  {
    #     stdout {
    #         codec => rubydebug
    #     }
    #     elasticsearch {
	# 		hosts => "elasticsearch:9200"
    #         index => "logstash-nav-server-pro-%{+YYYY.MM.dd}"
    #         #template_overwrite => true
    #         user => logstash
    #         password => logstash
    #     }
    # }
}